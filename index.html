<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>WHO RUN CITY</title>
<style>
html,body{margin:0;overflow:hidden;background:#000}
#game{width:100vw;height:100vh}
#status{
  position:fixed;
  top:10px;
  left:10px;
  color:#0f0;
  font-family:monospace;
  z-index:10;
}
.btn{
  position:fixed;bottom:20px;
  width:60px;height:60px;
  border-radius:50%;
  background:rgba(255,255,255,.25);
  color:#fff;font-size:22px;
  display:flex;align-items:center;justify-content:center;
}
#l{left:20px} #r{left:90px}
#f{right:90px} #b{right:20px}
</style>
</head>

<body>
<div id="status">Starting...</div>
<div id="game"></div>

<div class="btn" id="l">◀</div>
<div class="btn" id="r">▶</div>
<div class="btn" id="f">▲</div>
<div class="btn" id="b">▼</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/DRACOLoader.js"></script>

<script>
const status = t => document.getElementById("status").innerText = t;

let scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

let camera = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,5,10);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.getElementById("game").appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.6));
let sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(10,20,10);
scene.add(sun);

// DEBUG GROUND (MUST SHOW)
let ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshStandardMaterial({color:0x555555})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// DRACO
const draco = new THREE.DRACOLoader();
draco.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/libs/draco/");

const loader = new THREE.GLTFLoader();
loader.setDRACOLoader(draco);

let player, mixer, idle, walk;
let move={l:0,r:0,f:0,b:0};

status("Loading city...");
loader.load(
  "models/city.glb",
  g=>{
    g.scene.scale.set(1,1,1);
    g.scene.position.set(0,0,0);
    scene.add(g.scene);
    status("City loaded");
  },
  undefined,
  e=>status("City ERROR")
);

status("Loading player...");
loader.load(
  "models/player.glb",
  g=>{
    player = g.scene;
    player.scale.set(1,1,1);   // FORCE SCALE
    player.position.set(0,0,0);
    scene.add(player);

    mixer = new THREE.AnimationMixer(player);
    idle = mixer.clipAction(g.animations[0]);
    walk = g.animations[1] ? mixer.clipAction(g.animations[1]) : idle;
    idle.play();

    status("Player loaded");
  },
  undefined,
  e=>status("Player ERROR")
);

// TOUCH
const bind=(id,k)=>{
  let b=document.getElementById(id);
  b.ontouchstart=e=>{e.preventDefault();move[k]=1};
  b.ontouchend=e=>{e.preventDefault();move[k]=0};
};
bind("l","l");bind("r","r");bind("f","f");bind("b","b");

let clock = new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  let dt = clock.getDelta();
  if(mixer) mixer.update(dt);

  if(player){
    let moving = move.f||move.b||move.l||move.r;
    if(moving && !walk.isRunning()){
      idle.stop(); walk.play();
    }
    if(!moving && !idle.isRunning()){
      walk.stop(); idle.play();
    }

    let s=0.08;
    if(move.f) player.position.z-=s;
    if(move.b) player.position.z+=s;
    if(move.l) player.position.x-=s;
    if(move.r) player.position.x+=s;

    camera.position.x = player.position.x;
    camera.position.z = player.position.z + 10;
    camera.lookAt(player.position);
  }

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
