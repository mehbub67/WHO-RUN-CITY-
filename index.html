<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>WHO RUN CITY</title>

<style>
html,body{margin:0;overflow:hidden;background:#000}
#game{width:100vw;height:100vh}
#status{
  position:fixed;
  top:8px;
  left:8px;
  color:#0f0;
  font-family:monospace;
  font-size:12px;
  z-index:10;
  white-space:pre;
}
.btn{
  position:fixed;
  bottom:20px;
  width:60px;height:60px;
  border-radius:50%;
  background:rgba(255,255,255,.25);
  color:#fff;font-size:22px;
  display:flex;align-items:center;justify-content:center;
}
#l{left:20px} #r{left:90px}
#f{right:90px} #b{right:20px}
</style>
</head>

<body>
<div id="status">Starting…</div>
<div id="game"></div>

<div class="btn" id="l">◀</div>
<div class="btn" id="r">▶</div>
<div class="btn" id="f">▲</div>
<div class="btn" id="b">▼</div>

<script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://unpkg.com/three@0.150.1/examples/js/loaders/DRACOLoader.js"></script>

<script>
const log = t => document.getElementById("status").textContent += "\n"+t;
window.onerror = (m,s,l)=>log("JS ERROR: "+m+" @"+l);

log("JS OK");

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,2000);
camera.position.set(0,6,12);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.getElementById("game").appendChild(renderer.domElement);
log("Renderer OK");

scene.add(new THREE.AmbientLight(0xffffff,0.7));
const sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(10,30,10);
scene.add(sun);

// DEBUG GROUND (ALWAYS VISIBLE)
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(500,500),
  new THREE.MeshStandardMaterial({color:0x555555})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// DRACO (CORRECT)
const draco = new DRACOLoader();
draco.setDecoderPath(
  "https://unpkg.com/three@0.150.1/examples/js/libs/draco/"
);

const loader = new GLTFLoader();
loader.setDRACOLoader(draco);

// AUTO CENTER + SCALE
function normalizeModel(obj){
  const box = new THREE.Box3().setFromObject(obj);
  const size = box.getSize(new THREE.Vector3()).length();
  const scale = 5 / size;
  obj.scale.setScalar(scale);
  box.setFromObject(obj);
  box.getCenter(obj.position).multiplyScalar(-1);
}

// LOAD CITY
log("Loading city…");
loader.load(
  "models/city.glb",
  g=>{
    normalizeModel(g.scene);
    scene.add(g.scene);
    log("City OK");
  },
  undefined,
  e=>log("City FAILED")
);

// LOAD PLAYER
let player;
log("Loading player…");
loader.load(
  "models/player.glb",
  g=>{
    player = g.scene;
    normalizeModel(player);
    scene.add(player);
    log("Player OK");
  },
  undefined,
  e=>log("Player FAILED")
);

// CONTROLS
let move={l:0,r:0,f:0,b:0};
["l","r","f","b"].forEach(k=>{
  document.getElementById(k).ontouchstart=e=>{e.preventDefault();move[k]=1};
  document.getElementById(k).ontouchend=e=>{e.preventDefault();move[k]=0};
});

// LOOP
function animate(){
  requestAnimationFrame(animate);
  if(player){
    const s=0.08;
    if(move.f) player.position.z-=s;
    if(move.b) player.position.z+=s;
    if(move.l) player.position.x-=s;
    if(move.r) player.position.x+=s;
    camera.position.x = player.position.x;
    camera.position.z = player.position.z + 12;
    camera.lookAt(player.position);
  }
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
