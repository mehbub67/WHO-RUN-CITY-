<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>WHO RUN CITY</title>

<style>
html,body{margin:0;overflow:hidden;background:#000}
#game{width:100vw;height:100vh}
#status{
  position:fixed;
  top:10px;
  left:10px;
  color:#0f0;
  font-family:monospace;
  z-index:10;
  white-space:pre;
}
.btn{
  position:fixed;bottom:20px;
  width:60px;height:60px;
  border-radius:50%;
  background:rgba(255,255,255,.25);
  color:#fff;font-size:22px;
  display:flex;align-items:center;justify-content:center;
}
#l{left:20px} #r{left:90px}
#f{right:90px} #b{right:20px}
</style>
</head>

<body>
<div id="status">Startingâ€¦</div>
<div id="game"></div>

<div class="btn" id="l">â—€</div>
<div class="btn" id="r">â–¶</div>
<div class="btn" id="f">â–²</div>
<div class="btn" id="b">â–¼</div>

<!-- SAFE THREE.JS VERSION -->
<script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://unpkg.com/three@0.150.1/examples/js/loaders/DRACOLoader.js"></script>

<script>
const statusEl = document.getElementById("status");
function log(t){ statusEl.textContent += "\n" + t; }

window.onerror = function(msg, src, line, col){
  log("JS ERROR:");
  log(msg);
  log("line:"+line);
};

log("JS running");

let scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

let camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,3,6);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.getElementById("game").appendChild(renderer.domElement);

log("Renderer OK");

// LIGHT
scene.add(new THREE.AmbientLight(0xffffff,0.6));
let sun = new THREE.DirectionalLight(0xffffff,1);
sun.position.set(5,10,5);
scene.add(sun);

// ðŸ”´ TEST CUBE (MUST SHOW)
let cube = new THREE.Mesh(
  new THREE.BoxGeometry(1,1,1),
  new THREE.MeshStandardMaterial({color:0xff0000})
);
scene.add(cube);
log("Test cube added");

// GROUND
let ground = new THREE.Mesh(
  new THREE.PlaneGeometry(50,50),
  new THREE.MeshStandardMaterial({color:0x555555})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

renderer.render(scene,camera);
log("First render done");

// DRACO
const draco = new THREE.DRACOLoader();
draco.setDecoderPath("https://unpkg.com/three@0.150.1/examples/js/libs/draco/");
const loader = new THREE.GLTFLoader();
loader.setDRACOLoader(draco);

// LOAD CITY
log("Loading cityâ€¦");
loader.load(
  "models/city.glb",
  g=>{
    g.scene.scale.set(1,1,1);
    scene.add(g.scene);
    log("City loaded");
  },
  undefined,
  e=>log("City load FAILED")
);

// LOAD PLAYER
let player;
log("Loading playerâ€¦");
loader.load(
  "models/player.glb",
  g=>{
    player = g.scene;
    player.scale.set(1,1,1);
    scene.add(player);
    log("Player loaded");
  },
  undefined,
  e=>log("Player load FAILED")
);

// CONTROLS
let move={l:0,r:0,f:0,b:0};
const bind=(id,k)=>{
  let b=document.getElementById(id);
  b.ontouchstart=e=>{e.preventDefault();move[k]=1};
  b.ontouchend=e=>{e.preventDefault();move[k]=0};
};
bind("l","l");bind("r","r");bind("f","f");bind("b","b");

function animate(){
  requestAnimationFrame(animate);
  if(player){
    let s=0.05;
    if(move.f) player.position.z-=s;
    if(move.b) player.position.z+=s;
    if(move.l) player.position.x-=s;
    if(move.r) player.position.x+=s;
    camera.position.x = player.position.x;
    camera.position.z = player.position.z + 6;
    camera.lookAt(player.position);
  }
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
